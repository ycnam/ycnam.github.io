---
import { getCollection, render } from 'astro:content';
import { Image } from 'astro:assets';
import WorksLayout from '../../layouts/WorksLayout.astro';
import type { ImageMetadata } from 'astro';

export async function getStaticPaths() {
  const works = await getCollection('works');
  return works.map((work) => ({
    params: { slug: work.id },
    props: { work },
  }));
}

const { work } = Astro.props;
const { Content } = await render(work);

// Gallery images — resolved from local files in src/data/works/{slug}/
const allWorkImages = import.meta.glob<{ default: ImageMetadata }>(
  '/src/data/works/**/*.{jpg,jpeg,png,gif,webp}',
  { eager: true }
);

const galleryImages = work.data.galleryImages
  .map((filename) => allWorkImages[`/src/data/works/${work.id}/${filename}`]?.default)
  .filter((img): img is ImageMetadata => img !== undefined);

// p5 sketch URL — conditionally resolved only when hasP5Sketch is true
const sketchModules = import.meta.glob<{ default: string }>(
  '/src/data/works/*/sketch.js',
  { query: '?url', eager: true }
);
const sketchUrl = work.data.hasP5Sketch
  ? sketchModules[`/src/data/works/${work.id}/sketch.js`]?.default
  : undefined;
---

<WorksLayout title={work.data.title} currentSlug={work.id}>
  <article class="work-detail">
    <header class="work-header">
      <h1 class="work-title">{work.data.title}</h1>
      <div class="work-meta">
        <span class="work-category">{work.data.category}</span>
        {work.data.year && <span class="work-year">{work.data.year}</span>}
      </div>
    </header>

    {work.data.vimeoIds.length > 0 && (
      <div class="vimeo-list">
        {work.data.vimeoIds.map((id) => (
          <div class="vimeo-wrapper">
            <iframe
              src={`https://player.vimeo.com/video/${id}`}
              loading="lazy"
              allow="autoplay; fullscreen; picture-in-picture"
              allowfullscreen
              title={`${work.data.title} — Vimeo`}
            />
          </div>
        ))}
      </div>
    )}

    {galleryImages.length > 0 && (
      <div class="gallery">
        {galleryImages.map((img, i) => (
          <div class="gallery-item">
            <Image
              src={img}
              alt={`${work.data.title} — image ${i + 1}`}
              loading="lazy"
              class="gallery-img"
            />
          </div>
        ))}
      </div>
    )}

    <div class="work-content prose dark:prose-invert max-w-none">
      <Content />
    </div>

    {work.data.hasP5Sketch && <div id="p5-canvas" class="p5-canvas"></div>}
  </article>

  {sketchUrl && (
    <script define:vars={{ sketchUrl }} is:inline>
      (function () {
        var p5s = document.createElement('script');
        p5s.src = 'https://cdn.jsdelivr.net/npm/p5@1.9.4/lib/p5.min.js';
        p5s.onload = function () {
          var ks = document.createElement('script');
          ks.src = sketchUrl;
          document.body.appendChild(ks);
        };
        document.head.appendChild(p5s);
      })();
    </script>
  )}
</WorksLayout>

<style>
  .work-detail {
    padding-top: 0.25rem;
  }

  .work-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .work-title {
    font-size: 1.2rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    color: var(--color-text);
    line-height: 1.3;
    word-break: keep-all;
    overflow-wrap: break-word;
  }

  .work-meta {
    display: flex;
    gap: 0.6rem;
    font-size: 0.72rem;
    color: var(--color-muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .work-year::before {
    content: '·';
    margin-right: 0.6rem;
  }

  /* Vimeo embeds */
  .vimeo-list {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    margin-bottom: 1.75rem;
  }

  .vimeo-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
    background-color: var(--color-text);
    overflow: hidden;
  }

  .vimeo-wrapper iframe {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border: none;
  }

  /* Gallery */
  .gallery {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1.75rem;
  }

  .gallery-item {
    line-height: 0;
  }

  .gallery-img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Markdown content */
  .work-content {
    font-size: 0.875rem;
    margin-top: 1.5rem;
  }

  /* p5 canvas container */
  .p5-canvas {
    margin-top: 1.5rem;
    width: 100%;
    min-height: 200px;
  }

  /* Responsive iframes embedded in markdown prose */
  .work-content :global(iframe) {
    width: 100%;
    aspect-ratio: 16 / 9;
    height: auto;
    border: none;
    display: block;
    margin: 1rem 0;
  }
</style>
